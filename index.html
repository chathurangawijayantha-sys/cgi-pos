<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>‡∂ú‡∑ê‡∂∏‡∑í ‡∂ë‡∑Ö‡∑Ä‡∑Ö‡∑î - POS Pro Smart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f7f6; overflow-y: auto; height: auto; }
        .main-container { display: flex; flex-direction: row; min-height: 100vh; width: 100%; }
        #product-section { width: 60%; padding: 15px; border-right: 1px solid #ddd; background: #fff; overflow-y: auto; }
        #bill-section { width: 40%; background: #fff; padding: 15px; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .item-card { background: white; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; border: 1px solid #eee; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .item-card img { width: 100%; height: 80px; object-fit: cover; border-radius: 5px; }
        .item-card h4 { margin: 8px 0 4px 0; font-size: 13px; }
        .out-of-stock { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .out-of-stock-label { position: absolute; top: 40%; left: 50%; transform: translate(-50% , -50%); background: rgba(231, 76, 60, 0.9); color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; font-weight: bold; z-index: 10; }
        .price-tag { font-size: 12px; font-weight: bold; color: #27ae60; }
        .stock-tag { font-size: 11px; color: #7f8c8d; }
        .bill-header { text-align: center; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .bill-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .bill-table th { border-bottom: 1px solid black; padding: 5px; text-align: left; }
        .bill-table td { padding: 8px 2px; border-bottom: 1px dashed #eee; }
        .total-area { margin-top: 20px; border-top: 2px solid #333; padding-top: 10px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; font-weight: bold; }
        .sinhala-words { font-size: 11px; color: #333; font-weight: bold; display: block; text-align: right; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn-print { width: 100%; padding: 12px; background:#27ae60; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px; font-size: 16px; }
        #unitModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:25px; border-radius:15px; box-shadow:0 0 30px rgba(0,0,0,0.3); z-index:200; min-width:260px; }
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:150; }
        .price-info { background: #f9f9f9; padding: 8px; border-radius: 5px; margin: 10px 0; font-size: 13px; text-align: center; }
        #offline-status { display: none; background: #e74c3c; color: white; text-align: center; padding: 5px; font-size: 12px; position: fixed; top: 0; width: 100%; z-index: 1000; }

        .history-section { padding: 15px; background: #fff; margin: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .history-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 13px; }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2e7d32; display: flex; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 300px; text-align: center; color: #333; }
        .login-box input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }

        @media screen and (max-width: 800px) {
            .main-container { flex-direction: column; }
            #product-section { width: auto; border-right: none; }
            #bill-section { width: auto; }
        }

        @media print {
            .no-print, button, input, select, .history-section { display: none !important; }
            #printable-bill { width: 100% !important; display: block !important; padding: 0 !important; }
        }
    </style>
</head>
<body onbeforeunload="return handleReload()">

<div id="login-screen">
    <div class="login-box">
        <h3 style="color: #2e7d32; margin-top: 0;">‡∂ú‡∑ê‡∂∏‡∑í ‡∂ë‡∑Ö‡∑Ä‡∑Ö‡∑î POS - Login</h3>
        <input type="email" id="loginEmail" placeholder="Email ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫">
        <input type="password" id="loginPass" placeholder="Password">
        <button onclick="handleLogin()" style="width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂±</button>
        <p id="loginError" style="color: red; font-size: 12px; margin-top: 10px; display: none;">‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∂ö‡∑ä, ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!</p>
    </div>
</div>

<div id="mainUI" style="display: none;">
    <div class="main-container">
        <div id="product-section"><div class="grid" id="grid"></div></div>
        <div id="bill-section">
            <div id="printable-bill">
                <div class="bill-header">
                    <h3 style="margin:0; color: #2e7d32;">‡∂ú‡∑ê‡∂∏‡∑í ‡∂ë‡∑Ö‡∑Ä‡∑Ö‡∑î ‡∂ö‡∑ú‡∑Ö ‡∂ö‡∂©‡∑ö</h3>
                    <p style="margin:2px 0; font-size:12px; font-weight: bold;">‡∂±‡∑ú. 53, ‡∂ö‡∑Ö‡∑î‡∂≠‡∂ª ‡∂¥‡∑è‡∂ª, ‡∂∂‡∂´‡∑ä‡∂©‡∑è‡∂ª‡∂ú‡∂∏</p>
                    <div style="display:flex; justify-content:space-between; font-size:10px; border-top: 1px solid #eee; padding-top: 5px;">
                        <span>‡∂∂‡∑í‡∂Ω‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫: <b id="bNoDisplay"></b></span>
                        <span id="dtDisplay"></span>
                    </div>
                </div>
                <table class="bill-table">
                    <thead><tr><th>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫</th><th>‡∂∏‡∑í‡∂Ω</th><th>‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´</th><th style="text-align:right;">‡∂∏‡∑î‡∂Ø‡∂Ω</th></tr></thead>
                    <tbody id="bBody"></tbody>
                </table>
                <div class="total-area">
                    <div class="summary-row"><span>‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∂ú‡∂´‡∂±:</span> <span id="itemCount">0</span></div>
                    <div class="summary-row" style="font-size:18px; border-top: 1px dashed black; padding-top: 5px;"><span>‡∂∏‡∑î‡∑Ö‡∑î ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä:</span> <span>Rs. <span id="gTot">0.00</span></span></div>
                    <span id="gTotWords" class="sinhala-words">‡∂ª‡∑î‡∂¥‡∑í‡∂∫‡∂Ω‡∑ä ‡∂∂‡∑í‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä‡∂∫‡∑í</span>
                    <div class="summary-row"><span>‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω:</span> <span>Rs. <span id="cashDisplay">0.00</span></span></div>
                    <div class="summary-row" style="color:red;"><span>‡∂â‡∂≠‡∑í‡∂ª‡∑í ‡∂∏‡∑î‡∂Ø‡∂Ω:</span> <span>Rs. <span id="balDisplay">0.00</span></span></div>
                </div>
            </div>
            <div class="no-print" style="display: flex; flex-direction: column; gap: 5px;">
                <input type="number" id="cashInput" oninput="calc()" placeholder="‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω" style="padding: 10px; margin-top: 10px;">
                <button class="btn-print" onclick="finalizeBillAndPrint(true)">‡∂∏‡∑î‡∂Ø‡∑ä‚Äç‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                <button class="btn-print" style="background: #34495e;" onclick="finalizeBillAndPrint(false)">‡∂∏‡∑î‡∂Ø‡∑ä‚Äç‡∂ª‡∂´‡∂∫ ‡∂±‡∑ú‡∂ö‡∂ª ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                <button class="btn-print" style="background: #c0392b;" onclick="handleLogout()">Logout</button>
            </div>
        </div>
    </div>
    <div class="history-section no-print">
        <h3 style="color: #2e7d32;">‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä üìú</h3>
        <div id="history-list">‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</div>
    </div>
</div>

<div class="modal-overlay" id="overlay" onclick="closeModal()"></div>
<div id="unitModal">
    <h3 id="mTitle" style="margin:0;"></h3>
    <div class="price-info" id="pricePreview"></div>
    <input type="number" id="qty" placeholder="‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫" style="width:92%; padding:10px;">
    <button onclick="confirmAdd()" style="width:100%; padding:12px; background:#27ae60; color:white; border:none; margin-top:10px; font-weight:bold;">‡∂∂‡∑í‡∂Ω‡∂ß ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-KExZu3r71Z8KZsMzddNJ-i20Y6bptXY",
      authDomain: "cgi-pos.firebaseapp.com",
      databaseURL: "https://cgi-pos-default-rtdb.firebaseio.com/",
      projectId: "cgi-pos",
      storageBucket: "cgi-pos.firebasestorage.app",
      messagingSenderId: "425200021707",
      appId: "1:425200021707:web:c72bbeb221d8afa3deab4e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.handleLogin = function() {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        signInWithEmailAndPassword(auth, email, pass).catch(() => {
            document.getElementById('loginError').style.display = 'block';
        });
    };

    window.handleLogout = function() { if(confirm("Logout?")) signOut(auth); };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('mainUI').style.display = 'block';
            initializeAppMain();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('mainUI').style.display = 'none';
        }
    });

    window.auth = auth;
</script>

<script>
    const DB_URL = "https://cgi-pos-default-rtdb.firebaseio.com/";
    let inventory = []; let cart = [];
    let tempItem = null;

    async function initializeAppMain() {
        await fetchInventory();
        fetchBillHistory();
    }

    async function fetchInventory() {
        try {
            const token = await window.auth.currentUser.getIdToken();
            const res = await fetch(`${DB_URL}inventory.json?auth=${token}`);
            const data = await res.json();
            if(data) {
                inventory = Object.keys(data).map(key => ({
                    id: key, name: data[key].name || "‡∂±‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠", sell: data[key].sell || 0, stock: data[key].stock || 0, unit: data[key].unit || "", img: data[key].img || "none.jpg"
                }));
                render();
            }
        } catch (e) { console.error(e); }
    }

    async function fetchBillHistory() {
        try {
            const token = await window.auth.currentUser.getIdToken();
            const res = await fetch(`${DB_URL}sales.json?auth=${token}`);
            const data = await res.json();
            const listDiv = document.getElementById('history-list');
            if(data) {
                const bills = Object.values(data).reverse().slice(0, 10);
                listDiv.innerHTML = bills.map(b => `
                    <div class="history-item">
                        <span>‡∂∂‡∑í‡∂Ω‡∑ä: <b>${b.bNo}</b> (${b.date.split(',')[0]})</span>
                        <span><b>Rs. ${parseFloat(b.total).toFixed(2)}</b></span>
                    </div>
                `).join('');
            }
        } catch(e) { console.error(e); }
    }

    async function saveAsPDF() {
        const element = document.getElementById('printable-bill');
        const bNo = document.getElementById('bNoDisplay').innerText;
        const opt = { margin: 10, filename: 'Bill_' + bNo + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        await html2pdf().set(opt).from(element).save();
    }

    function render() {
        // --- ‡∂≠‡∑ú‡∂ú ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∂∫‡∂ß‡∂ß‡∂∏ ‡∂∫‡∂± ‡∂Ω‡∑ô‡∑É ‡∂¥‡∑ô‡∑Ö‡∂ú‡∑ê‡∑É‡∑ä‡∑Ä‡∑ì‡∂∏ (Sorting) ---
        const sortedInventory = [...inventory].sort((a, b) => (parseFloat(a.stock) <= 0) - (parseFloat(b.stock) <= 0));
        
        let html = "";
        sortedInventory.forEach(p => {
            const isOut = parseFloat(p.stock) <= 0;
            html += `<div class="item-card ${isOut ? 'out-of-stock' : ''}" onclick="${isOut ? '' : "openM('" + p.id + "')" }">
                <img src="images/${p.img}" onerror="this.src='https://via.placeholder.com/100'">
                <h4>${p.name}</h4><div class="price-tag">Rs. ${p.sell}</div>
                ${isOut ? '<div class="out-of-stock-label">‡∂≠‡∑ú‡∂ú ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä!</div>' : ''}
            </div>`;
        });
        document.getElementById('grid').innerHTML = html;
        document.getElementById('dtDisplay').innerText = new Date().toLocaleString('si-LK');
        document.getElementById('bNoDisplay').innerText = Math.floor(1000 + Math.random() * 9000);
    }

    function openM(id) {
        tempItem = inventory.find(x => x.id === id);
        document.getElementById('mTitle').innerText = tempItem.name;
        document.getElementById('pricePreview').innerText = "‡∂∏‡∑í‡∂Ω: Rs. " + tempItem.sell;
        document.getElementById('unitModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function confirmAdd() {
        const qty = parseFloat(document.getElementById('qty').value);
        if(!qty) return;
        const total = qty * tempItem.sell;
        cart.push({ n: tempItem.name, up: tempItem.sell, dq: qty + " " + tempItem.unit, t: total });
        updateUI(); closeModal();
    }

    function updateUI() {
        document.getElementById('bBody').innerHTML = cart.map(i => `<tr><td>${i.n}</td><td>${i.up}</td><td>${i.dq}</td><td style="text-align:right;">${i.t.toFixed(2)}</td></tr>`).join('');
        calc();
    }

    function calc() {
        const itemsTotal = cart.reduce((s, i) => s + i.t, 0);
        document.getElementById('gTot').innerText = itemsTotal.toFixed(2);
        document.getElementById('itemCount').innerText = cart.length;
        document.getElementById('gTotWords').innerText = priceToSinhalaWords(itemsTotal);
        const cash = parseFloat(document.getElementById('cashInput').value) || 0;
        document.getElementById('cashDisplay').innerText = cash.toFixed(2);
        document.getElementById('balDisplay').innerText = (cash - itemsTotal).toFixed(2);
    }

    async function finalizeBillAndPrint(shouldPrint) {
        if(cart.length === 0) return;
        try {
            const token = await window.auth.currentUser.getIdToken();
            const bNo = document.getElementById('bNoDisplay').innerText;
            const finalTotal = document.getElementById('gTot').innerText;
            for (let c of cart) {
                await fetch(`${DB_URL}sales.json?auth=${token}`, { method: 'POST', body: JSON.stringify({ bNo, date: new Date().toLocaleString(), name: c.n, qty: c.dq, total: finalTotal }) });
            }
            await saveAsPDF();
            if(shouldPrint) window.print();
            location.reload();
        } catch(e) { alert("Error!"); }
    }

    function closeModal() { document.getElementById('unitModal').style.display='none'; document.getElementById('overlay').style.display='none'; }
    function priceToSinhalaWords(amount) { return "‡∂ª‡∑î‡∂¥‡∑í‡∂∫‡∂Ω‡∑ä " + amount + " ‡∂∫‡∑í"; }
    function handleReload() { if (cart.length > 0) return "‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∂â‡∑Ä‡∂≠‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂Ø?"; }
</script>
</body>
</html>
