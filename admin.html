<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>CGI Pro Admin - Ultimate POS Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #27ae60;
            --secondary: #8e44ad;
            --dark: #2c3e50;
            --light: #f4f7f6;
            --danger: #e74c3c;
            --warning: #f39c12;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--light); color: var(--dark); }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        
        /* Header & Navigation */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #eee; border-radius: 10px; font-weight: 600; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; transform: translateY(-2px); }
        .tab-btn:hover:not(.active) { background: #e0e0e0; }

        /* Dashboard Cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; transition: 0.3s; border-bottom: 5px solid transparent; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { margin: 0; font-size: 14px; color: #7f8c8d; text-transform: uppercase; }
        .stat-card h2 { margin: 10px 0 0; font-size: 28px; }
        .card-revenue { border-color: #3498db; }
        .card-profit { border-color: var(--primary); }
        .card-expense { border-color: var(--danger); }

        /* Forms & Content */
        .content { display: none; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .content.active { display: block; }
        .section-title { margin-top: 0; display: flex; align-items: center; gap: 10px; color: var(--dark); }
        
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 25px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; }
        label { font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block; color: #555; }

        /* Buttons */
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* Charts */
        .chart-wrapper { position: relative; height: 400px; margin-top: 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; border: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: var(--dark); font-weight: 600; }
        tr:hover { background: #fcfcfc; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header no-print">
        <h2 style="margin:0; color: var(--primary);">CGI PRO ADMIN</h2>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('stock')">‡∂≠‡∑ú‡∂ú‡∂∫</button>
            <button class="tab-btn" onclick="showTab('sales')">‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä</button>
            <button class="tab-btn" onclick="showTab('expenses')">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</button>
            <button class="tab-btn" style="background:var(--secondary); color:white;" onclick="showTab('analytics')">‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ üìä</button>
        </div>
    </div>

    <div class="dashboard-grid no-print">
        <div class="stat-card card-revenue"><h3>‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏</h3><h2 id="dispRev">Rs. 0</h2></div>
        <div class="stat-card card-profit"><h3>‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∂Ω‡∑è‡∂∑‡∂∫</h3><h2 id="dispGProfit">Rs. 0</h2></div>
        <div class="stat-card card-expense"><h3>‡∂∏‡∑î‡∑Ö‡∑î ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</h3><h2 id="dispExp">Rs. 0</h2></div>
        <div class="stat-card" style="border-color: #2c3e50;"><h3>‡∑Å‡∑î‡∂Ø‡∑ä‡∂∞ ‡∂Ω‡∑è‡∂∑‡∂∫ (Net)</h3><h2 id="dispNetProfit" style="color:var(--primary);">Rs. 0</h2></div>
    </div>

    <div id="stock" class="content active">
        <h3 class="section-title">üì¶ ‡∂≠‡∑ú‡∂ú ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫</h3>
        <div class="grid-form no-print">
            <div><label>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∂±‡∂∏</label><input list="itemList" id="itemName" oninput="checkEx(this.value)"><datalist id="itemList"></datalist></div>
            <div><label>‡∂í‡∂ö‡∂ö‡∂∫</label><select id="itemUnit"><option>Kg</option><option>‡∂∏‡∑í‡∂ß‡∑í</option><option>‡∂¥‡∑ê‡∂ö‡∂ß‡∑ä</option><option>‡∂ö‡∂ª‡∂Ω‡∑ä</option></select></div>
            <div><label>‡∂ú‡∑ê‡∂±‡∑î‡∂∏‡∑ä ‡∂∏‡∑í‡∂Ω</label><input type="number" id="buyPrice"></div>
            <div><label>‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä ‡∂∏‡∑í‡∂Ω</label><input type="number" id="sellPrice"></div>
            <div><label>‡∂≠‡∑ú‡∂ú‡∂∫ ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</label><input type="number" id="addStock" value="0"></div>
            <button class="btn btn-primary" onclick="handleUpdate()">Update</button>
        </div>
        <table id="inventoryTable">
            <thead><tr><th>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫</th><th>‡∂í‡∂ö‡∂ö‡∂∫</th><th>‡∂ú‡∑ê‡∂±‡∑î‡∂∏‡∑ä</th><th>‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä</th><th>‡∂≠‡∑ú‡∂ú‡∂∫</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è</th></tr></thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>

    <div id="sales" class="content">
        <h3 class="section-title">üí∞ ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</h3>
        <div class="filter-section no-print" style="margin-bottom:20px;">
            <select id="reportFilter" onchange="renderSales()" style="width:200px;">
                <option value="all">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</option>
                <option value="today">‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂±</option>
                <option value="month">‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑è‡∑É‡∂∫</option>
            </select>
        </div>
        <table>
            <thead><tr><th>‡∂∂‡∑í‡∂Ω‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</th><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫</th><th>‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∂Ω‡∑è‡∂∑‡∂∫</th></tr></thead>
            <tbody id="salesBody"></tbody>
        </table>
    </div>

    <div id="expenses" class="content">
        <h3 class="section-title">üí∏ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</h3>
        <div class="grid-form no-print">
            <div><label>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</label><input type="text" id="expNote" placeholder="‡∂ã‡∂Ø‡∑è: ‡∑Ä‡∑í‡∂Ø‡∑î‡∂Ω‡∑í ‡∂∂‡∑í‡∂Ω"></div>
            <div><label>‡∂∏‡∑î‡∂Ø‡∂Ω (Rs.)</label><input type="number" id="expAmount"></div>
            <div><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="expDate"></div>
            <button class="btn btn-danger" onclick="addExpense()">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏ ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>
        <table>
            <thead><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω (Rs.)</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è</th></tr></thead>
            <tbody id="expenseBody"></tbody>
        </table>
    </div>

    <div id="analytics" class="content">
        <h3 class="section-title">üìà ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑è‡∂ª‡∑í‡∂ö ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫</h3>
        <div class="chart-wrapper">
            <canvas id="proChart"></canvas>
        </div>
        <div style="margin-top:30px;">
            <h4>‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∑É‡∑è‡∂∞‡∂±‡∂∫</h4>
            <tbody id="itemPerfBody"></tbody>
        </table>
    </div>
</div>

<script>
    const BASE_URL = "https://cgi-pos-default-rtdb.firebaseio.com/";
    let inventory = [], salesList = [], expenses = [], myChart = null;

    async function fetchData() {
        try {
            const [invRes, salesRes, expRes] = await Promise.all([
                fetch(`${BASE_URL}inventory.json`),
                fetch(`${BASE_URL}sales.json`),
                fetch(`${BASE_URL}expenses.json`)
            ]);
            
            const invData = await invRes.json();
            inventory = invData ? Object.values(invData) : [];
            
            const salesData = await salesRes.json();
            salesList = salesData ? Object.keys(salesData).map(k => ({...salesData[k], id: k})) : [];
            
            const expData = await expRes.json();
            expenses = expData ? Object.keys(expData).map(k => ({...expData[k], id: k})) : [];

            updateDashboard();
            renderInventory();
            renderSales();
            renderExpenses();
        } catch (e) { console.error("Fetch Error", e); }
    }

    function updateDashboard() {
        let rev = salesList.reduce((s, i) => s + parseFloat(i.total || 0), 0);
        let gProf = salesList.reduce((s, i) => s + parseFloat(i.profit || 0), 0);
        let exp = expenses.reduce((s, i) => s + parseFloat(i.amount || 0), 0);
        
        document.getElementById('dispRev').innerText = "Rs. " + rev.toLocaleString();
        document.getElementById('dispGProfit').innerText = "Rs. " + gProf.toLocaleString();
        document.getElementById('dispExp').innerText = "Rs. " + exp.toLocaleString();
        document.getElementById('dispNetProfit').innerText = "Rs. " + (gProf - exp).toLocaleString();
    }

    async function addExpense() {
        const note = document.getElementById('expNote').value;
        const amount = document.getElementById('expAmount').value;
        const date = document.getElementById('expDate').value || new Date().toISOString().split('T')[0];
        
        if(!note || !amount) return alert("‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");
        
        await fetch(`${BASE_URL}expenses.json`, { 
            method: 'POST', 
            body: JSON.stringify({ note, amount: parseFloat(amount), date }) 
        });
        
        document.getElementById('expNote').value = "";
        document.getElementById('expAmount').value = "";
        fetchData();
    }

    function renderExpenses() {
        document.getElementById('expenseBody').innerHTML = expenses.map(e => `
            <tr>
                <td>${e.date}</td><td>${e.note}</td><td>${e.amount.toFixed(2)}</td>
                <td><button onclick="delExp('${e.id}')" style="color:red; border:none; background:none; cursor:pointer;">‚ùå</button></td>
            </tr>`).join('');
    }

    async function delExp(id) { if(confirm("‡∂∏‡∂ö‡∂±‡∑ä‡∂±‡∂Ø?")) { await fetch(`${BASE_URL}expenses/${id}.json`, { method: 'DELETE' }); fetchData(); } }

    function renderAnalytics() {
        const stats = {};
        salesList.forEach(s => {
            if(!stats[s.name]) stats[s.name] = { rev: 0, prof: 0 };
            stats[s.name].rev += parseFloat(s.total || 0);
            stats[s.name].prof += parseFloat(s.profit || 0);
        });

        const ctx = document.getElementById('proChart').getContext('2d');
        if(myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(stats),
                datasets: [
                    { label: '‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏', data: Object.values(stats).map(x => x.rev), backgroundColor: '#3498db' },
                    { label: '‡∂Ω‡∑è‡∂∑‡∂∫', data: Object.values(stats).map(x => x.prof), backgroundColor: '#27ae60' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function showTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'analytics') renderAnalytics();
    }

    // --- ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∂Ö‡∂±‡∑ô‡∂ö‡∑ä Functions (Inventory, Sales etc.) ---
    function renderInventory() {
        document.getElementById('inventoryBody').innerHTML = inventory.map(i => `
            <tr>
                <td><strong>${i.name}</strong></td><td>${i.unit}</td><td>${i.buy}</td><td>${i.sell}</td><td>${i.stock}</td>
                <td><button onclick="editItem('${i.name}')" style="color:blue; border:none; background:none;">‚úé</button></td>
            </tr>`).join('');
        document.getElementById('itemList').innerHTML = inventory.map(i => `<option value="${i.name}">`).join('');
    }

    function renderSales() {
        const filter = document.getElementById('reportFilter').value;
        const now = new Date().toDateString();
        const filtered = salesList.filter(s => {
            if(filter === 'today') return new Date(s.date).toDateString() === now;
            return true;
        });
        document.getElementById('salesBody').innerHTML = filtered.map(s => `
            <tr><td>#${s.bNo}</td><td>${s.date}</td><td>${s.name}</td><td>${s.qty}</td><td>${s.total}</td><td>${s.profit}</td></tr>
        `).reverse().join('');
    }

    async function handleUpdate() {
        let n = document.getElementById('itemName').value;
        let u = document.getElementById('itemUnit').value;
        let b = parseFloat(document.getElementById('buyPrice').value) || 0;
        let s = parseFloat(document.getElementById('sellPrice').value) || 0;
        let st = parseFloat(document.getElementById('addStock').value) || 0;
        if(!n) return;
        let ex = inventory.find(i => i.name.toLowerCase() === n.toLowerCase());
        let item = ex ? { ...ex, buy: b, sell: s, unit: u, stock: (parseFloat(ex.stock) + st).toFixed(2) } 
                      : { id: Date.now(), name: n, unit: u, buy: b, sell: s, stock: st.toFixed(2) };
        await fetch(`${BASE_URL}inventory/${item.id}.json`, { method: 'PUT', body: JSON.stringify(item) });
        fetchData();
    }

    function checkEx(n) { let ex = inventory.find(i => i.name.toLowerCase() === n.toLowerCase()); if(ex){ document.getElementById('itemUnit').value=ex.unit; document.getElementById('buyPrice').value=ex.buy; document.getElementById('sellPrice').value=ex.sell; } }
    
    fetchData();
</script>
</body>
</html>
