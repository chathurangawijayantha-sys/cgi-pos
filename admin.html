<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>CGI Pro Admin - Full Advanced System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #27ae60;
            --secondary: #8e44ad;
            --dark: #2c3e50;
            --light: #f4f7f6;
            --danger: #e74c3c;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: var(--light); }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #eee; border-radius: 10px; font-weight: 600; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; transform: translateY(-2px); }

        /* Dashboard Cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border-bottom: 5px solid transparent; }
        .stat-card h3 { margin: 0; font-size: 13px; color: #7f8c8d; text-transform: uppercase; }
        .stat-card h2 { margin: 10px 0 0; font-size: 24px; }
        .card-revenue { border-color: #3498db; }
        .card-profit { border-color: var(--primary); }
        .card-expense { border-color: var(--danger); }
        .card-net { border-color: var(--secondary); }

        .content { display: none; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .content.active { display: block; }
        
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 25px; align-items: flex-end; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; }
        label { font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block; color: #555; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #34495e; color: white; }
        .low-stock-row { background-color: #ffcccc !important; color: #b71c1c; font-weight: bold; }

        .search-box { margin-bottom: 15px; padding: 12px; border: 2px solid var(--primary); width: 100%; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        
        .chart-container { height: 400px; position: relative; margin-top: 20px; }

        @media print { .no-print { display: none !important; } .content { display: block !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header no-print">
        <h2 style="margin:0; color: var(--primary);">CGI PRO ADMIN</h2>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('stock')">‡∂≠‡∑ú‡∂ú ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫</button>
            <button class="tab-btn" onclick="showTab('sales')">‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</button>
            <button class="tab-btn" onclick="showTab('expenses')">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</button>
            <button class="tab-btn" style="background:var(--secondary); color:white;" onclick="showTab('analytics')">‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ üìä</button>
        </div>
    </div>

    <div class="dashboard-grid no-print">
        <div class="stat-card card-revenue"><h3>‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏</h3><h2 id="dispRev">Rs. 0</h2></div>
        <div class="stat-card card-profit"><h3>‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∂Ω‡∑è‡∂∑‡∂∫</h3><h2 id="dispGProfit">Rs. 0</h2></div>
        <div class="stat-card card-expense"><h3>‡∂∏‡∑î‡∑Ö‡∑î ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä</h3><h2 id="dispExp">Rs. 0</h2></div>
        <div class="stat-card card-net"><h3>‡∑Å‡∑î‡∂Ø‡∑ä‡∂∞ ‡∂Ω‡∑è‡∂∑‡∂∫</h3><h2 id="dispNetProfit">Rs. 0</h2></div>
    </div>

    <div id="stock" class="content active">
        <div class="grid-form no-print">
            <div><label>‡∂±‡∂∏</label><input list="itemList" id="itemName" oninput="checkEx(this.value)"><datalist id="itemList"></datalist></div>
            <div><label>‡∂í‡∂ö‡∂ö‡∂∫</label><select id="itemUnit"><option>Kg</option><option>‡∂∏‡∑í‡∂ß‡∑í</option><option>‡∂¥‡∑ê‡∂ö‡∂ß‡∑ä</option><option>‡∂ö‡∂ª‡∂Ω‡∑ä</option></select></div>
            <div><label>‡∂ú‡∑ê‡∂±‡∑î‡∂∏‡∑ä</label><input type="number" id="buyPrice"></div>
            <div><label>‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä</label><input type="number" id="sellPrice"></div>
            <div><label>‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂≠‡∑ú‡∂ú‡∂∫</label><input type="number" id="addStock" value="0"></div>
            <div><label>‡∂¥‡∑í‡∂±‡∑ä‡∂≠‡∑ñ‡∂ª‡∂∫</label><input type="text" id="itemImg" placeholder="carrot.jpg"></div>
            <button class="btn btn-primary" onclick="handleUpdate()">Update / Add</button>
        </div>

        <input type="text" id="inventorySearch" class="search-box no-print" placeholder="üîç ‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∂±‡∂∏ ‡∂ß‡∂∫‡∑í‡∂¥‡∑ä ‡∂ö‡∂ª ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±..." onkeyup="searchInventory()">
        
        <table id="inventoryTable">
            <thead><tr><th>‡∂¥‡∑í‡∂±‡∑ä‡∂≠‡∑ñ‡∂ª‡∂∫</th><th>‡∂±‡∂∏</th><th>‡∂í‡∂ö‡∂ö‡∂∫</th><th>‡∂ú‡∑ê‡∂±‡∑î‡∂∏‡∑ä</th><th>‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∂∏‡∑ä</th><th>‡∂Ω‡∑è‡∂∑ %</th><th>‡∂≠‡∑ú‡∂ú‡∂∫</th><th class="no-print">‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è</th></tr></thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>

    <div id="sales" class="content">
        <div class="filter-section no-print" style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
            <div><label>‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±:</label>
                <select id="reportFilter" onchange="renderSales()" style="width:200px;">
                    <option value="all">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</option>
                    <option value="today" selected>‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂± (Today)</option>
                    <option value="month">‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑è‡∑É‡∂∫</option>
                    <option value="custom">‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂Ø‡∑í‡∂±‡∂∫‡∂ö‡∑ä</option>
                </select>
            </div>
            <div id="customDateDiv" style="display:none;">
                <label>‡∂Ø‡∑í‡∂±‡∂∫:</label>
                <input type="date" id="customDate" onchange="renderSales()">
            </div>
        </div>
        <table>
            <thead><tr><th>‡∂∂‡∑í‡∂Ω‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</th><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫</th><th>‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∂Ω‡∑è‡∂∑‡∂∫</th></tr></thead>
            <tbody id="salesBody"></tbody>
        </table>
    </div>

    <div id="expenses" class="content">
        <h3 class="section-title">üí∏ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫</h3>
        <div class="grid-form no-print">
            <div><label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><input type="text" id="expNote" placeholder="‡∂ã‡∂Ø‡∑è: ‡∑Ä‡∑í‡∂Ø‡∑î‡∂Ω‡∑í ‡∂∂‡∑í‡∂Ω"></div>
            <div><label>‡∂∏‡∑î‡∂Ø‡∂Ω (Rs.)</label><input type="number" id="expAmount"></div>
            <div><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="expDate"></div>
            <button class="btn" style="background:var(--danger); color:white;" onclick="addExpense()">‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        </div>
        <table id="expenseTable">
            <thead><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω (Rs.)</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è</th></tr></thead>
            <tbody id="expenseBody"></tbody>
        </table>
    </div>

    <div id="analytics" class="content">
        <h3 class="section-title">üìä ‡∂ö‡∑è‡∂Ω ‡∂¥‡∂ª‡∑è‡∑É‡∂∫ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫</h3>
        <div class="filter-section no-print" style="margin-bottom:20px;">
            <select id="chartPeriod" onchange="renderAnalytics()" style="width:200px;">
                <option value="today">‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂±</option>
                <option value="weekly">‡∂∏‡∑ô‡∂∏ ‡∑É‡∂≠‡∑í‡∂∫</option>
                <option value="monthly">‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑è‡∑É‡∂∫</option>
                <option value="all" selected>‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂ö‡∑è‡∂Ω‡∂∫</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="proChart"></canvas>
        </div>
    </div>
</div>

<script>
    const BASE_URL = "https://cgi-pos-default-rtdb.firebaseio.com/";
    let inventory = [], salesList = [], expenses = [], myChart = null;

    async function fetchData() {
        try {
            const [invRes, salesRes, expRes] = await Promise.all([
                fetch(`${BASE_URL}inventory.json`),
                fetch(`${BASE_URL}sales.json`),
                fetch(`${BASE_URL}expenses.json`)
            ]);
            
            const invData = await invRes.json();
            inventory = invData ? Object.values(invData) : [];
            
            const salesData = await salesRes.json();
            salesList = salesData ? Object.keys(salesData).map(k => ({...salesData[k], firebaseKey: k})) : [];
            
            const expData = await expRes.json();
            expenses = expData ? Object.keys(expData).map(k => ({...expData[k], id: k})) : [];

            updateDashboard(); renderInventory(); renderSales(); renderExpenses();
        } catch (e) { console.error(e); }
    }

    function updateDashboard() {
        let rev = salesList.reduce((s, i) => s + parseFloat(i.total || 0), 0);
        let gProf = salesList.reduce((s, i) => s + parseFloat(i.profit || 0), 0);
        let exp = expenses.reduce((s, i) => s + parseFloat(i.amount || 0), 0);
        
        document.getElementById('dispRev').innerText = "Rs. " + rev.toLocaleString();
        document.getElementById('dispGProfit').innerText = "Rs. " + gProf.toLocaleString();
        document.getElementById('dispExp').innerText = "Rs. " + exp.toLocaleString();
        document.getElementById('dispNetProfit').innerText = "Rs. " + (gProf - exp).toLocaleString();
    }

    function renderInventory() {
        document.getElementById('inventoryBody').innerHTML = inventory.map(item => {
            let profitPct = item.buy > 0 ? ((item.sell - item.buy) / item.buy * 100).toFixed(0) : 0;
            let rowClass = parseFloat(item.stock) <= 0 ? 'low-stock-row' : '';
            return `<tr class="${rowClass}">
                <td><img src="images/${item.img || 'none.jpg'}" width="40" height="40" style="object-fit:cover; border-radius:5px;" onerror="this.src='https://via.placeholder.com/40'"></td>
                <td><strong>${item.name}</strong></td><td>${item.unit}</td><td>${item.buy}</td><td>${item.sell}</td>
                <td>${profitPct}%</td><td>${item.stock}</td>
                <td><button onclick="editItem('${item.name}')" style="color:blue; border:none; background:none; cursor:pointer;">‚úé</button></td>
            </tr>`;
        }).join('');
        document.getElementById('itemList').innerHTML = inventory.map(i => `<option value="${i.name}">`).join('');
    }

    function renderSales() {
        const filter = document.getElementById('reportFilter').value;
        const customDate = document.getElementById('customDate').value;
        const now = new Date();
        const todayStr = now.toLocaleDateString('en-GB');
        document.getElementById('customDateDiv').style.display = (filter === 'custom') ? 'block' : 'none';

        const filtered = salesList.filter(s => {
            if(filter === 'all') return true;
            const sDate = new Date(s.date);
            const sDateISO = sDate.toLocaleDateString('en-GB');
            if(filter === 'today') return sDateISO === todayStr;
            if(filter === 'month') return sDate.getMonth() === now.getMonth() && sDate.getFullYear() === now.getFullYear();
            if(filter === 'custom' && customDate) return sDateISO === new Date(customDate).toLocaleDateString('en-GB');
            return true;
        });

        document.getElementById('salesBody').innerHTML = filtered.map(s => `
            <tr><td>#${s.bNo}</td><td>${s.date}</td><td>${s.name}</td><td>${s.qty}</td><td>${s.total}</td><td>${s.profit}</td></tr>
        `).reverse().join('');
    }

    async function handleUpdate() {
        let n = document.getElementById('itemName').value, u = document.getElementById('itemUnit').value;
        let b = parseFloat(document.getElementById('buyPrice').value) || 0, s = parseFloat(document.getElementById('sellPrice').value) || 0;
        let st = parseFloat(document.getElementById('addStock').value) || 0, img = document.getElementById('itemImg').value;
        if(!n) return;
        let ex = inventory.find(i => i.name.toLowerCase() === n.toLowerCase());
        let item = ex ? { ...ex, buy: b, sell: s, unit: u, img: img, stock: (parseFloat(ex.stock) + st).toFixed(2) } 
                      : { id: Date.now(), name: n, unit: u, buy: b, sell: s, stock: st.toFixed(2), img: img };
        await fetch(`${BASE_URL}inventory/${item.id}.json`, { method: 'PUT', body: JSON.stringify(item) });
        fetchData(); clearForm();
    }

    async function addExpense() {
        const note = document.getElementById('expNote').value, amount = document.getElementById('expAmount').value;
        const date = document.getElementById('expDate').value || new Date().toISOString().split('T')[0];
        if(!note || !amount) return;
        await fetch(`${BASE_URL}expenses.json`, { method: 'POST', body: JSON.stringify({ note, amount: parseFloat(amount), date }) });
        fetchData();
    }

    function renderExpenses() {
        document.getElementById('expenseBody').innerHTML = expenses.map(e => `
            <tr><td>${e.date}</td><td>${e.note}</td><td>${e.amount}</td>
            <td><button onclick="delExp('${e.id}')" style="color:red; border:none; background:none; cursor:pointer;">‚ùå</button></td></tr>`).join('');
    }

    async function delExp(id) { if(confirm("‡∂∏‡∂ö‡∂±‡∑ä‡∂±‡∂Ø?")) { await fetch(`${BASE_URL}expenses/${id}.json`, { method: 'DELETE' }); fetchData(); } }
    
    function showTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'analytics') renderAnalytics();
    }

    function renderAnalytics() {
        const period = document.getElementById('chartPeriod').value;
        const stats = {};
        salesList.forEach(s => {
            if(!stats[s.name]) stats[s.name] = { rev: 0 };
            stats[s.name].rev += parseFloat(s.total || 0);
        });
        const ctx = document.getElementById('proChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(stats), datasets: [{ label: '‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏', data: Object.values(stats).map(x => x.rev), backgroundColor: '#3498db' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function checkEx(n) { let ex = inventory.find(i => i.name.toLowerCase() === n.toLowerCase()); if(ex){ document.getElementById('itemUnit').value=ex.unit; document.getElementById('buyPrice').value=ex.buy; document.getElementById('sellPrice').value=ex.sell; document.getElementById('itemImg').value=ex.img || ''; } }
    function clearForm() { document.getElementById('itemName').value=""; document.getElementById('buyPrice').value=""; document.getElementById('sellPrice').value=""; document.getElementById('addStock').value="0"; document.getElementById('itemImg').value=""; }
    function searchInventory() { let q = document.getElementById('inventorySearch').value.toLowerCase(); document.querySelectorAll('#inventoryBody tr').forEach(tr => { tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none'; }); }
    function editItem(n) { let i = inventory.find(x => x.name === n); if(i) { document.getElementById('itemName').value=i.name; document.getElementById('itemUnit').value=i.unit; document.getElementById('buyPrice').value=i.buy; document.getElementById('sellPrice').value=i.sell; document.getElementById('itemImg').value=i.img || ''; window.scrollTo(0,0); } }

    fetchData();
</script>
</body>
</html>
